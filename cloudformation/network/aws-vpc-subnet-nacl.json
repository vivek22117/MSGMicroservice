{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "NACL and its association with subnets",
  "Parameters": {
    "VPCStackName": {
      "Description": "VPC to refer",
      "Type": "String"
    },
    "Environment" : {
      "Description" : "Environment to which cft is created",
      "Type" : "String",
      "Default" : "devl"
    }
  },
  "Resources": {
    "DDPublicNetworkAcl": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-VPCId"}},
        "Tags": [
          {
            "Key": "Name",
            "Value": "DD-egress-NACL"
          },
          {
            "Key": "component",
            "Value": "double-digit-test"
          },
          {
            "Key": "environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Scope",
            "Value": "public"
          }
        ]
      }
    },
    "InboundPublicNACLAllowVPCSubnet": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "100",
        "Protocol": -1,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-VPCCidrBlock"}},
        "PortRange": {
          "From": "0",
          "To": "65535"
        }
      }
    },
    "InboundPublicNACLAllowSSH": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "101",
        "Protocol": 6,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "22",
          "To": "22"
        }
      }
    },
    "InboundPublicNACLAllowRemoteNetwork": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "105",
        "Protocol": 17,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "123",
          "To": "123"
        }
      }
    },
    "InboundPublicNACLAllowHTTP": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "110",
        "Protocol": 6,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "80",
          "To": "80"
        }
      }
    },
    "InboundPublicNACLAllowHTTPS": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "115",
        "Protocol": 6,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "443",
          "To": "443"
        }
      }
    },
    "InboundPublicNACLDenyMSSQL": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "120",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1433",
          "To": "1433"
        }
      }
    },
    "InboundPublicNACLDenyOracle": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "125",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1521",
          "To": "1521"
        }
      }
    },
    "InboundPublicNACLDenyAurora": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "130",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "3306",
          "To": "3306"
        }
      }
    },
    "InboundPublicNACLDenyNFS": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "135",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "2049",
          "To": "2049"
        }
      }
    },
    "InboundPublicNACLDenyRDP": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "140",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "3389",
          "To": "3389"
        }
      }
    },
    "InboundPublicNACLDenyPostgreSQL": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "145",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "5432",
          "To": "5432"
        }
      }
    },
    "InboundPublicNACLDeny8080": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "150",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "8080",
          "To": "8080"
        }
      }
    },
    "InboundPublicNACLDeny8443": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "155",
        "Protocol": 6,
        "RuleAction": "deny",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "8443",
          "To": "8443"
        }
      }
    },
    "InboundPublicNACLAllTraffic": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "160",
        "Protocol": 6,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1024",
          "To": "65535"
        }
      }
    },
    "OutboundPublicNACLAllTraffic": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPublicNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        },
        "RuleNumber": "170",
        "Protocol": -1,
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "0",
          "To": "65535"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPublicSubnetA": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-SubnetId-A"}},
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPublicSubnetB": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-SubnetId-B"}},
        "NetworkAclId": {
          "Ref": "DDPublicNetworkAcl"
        }
      }
    },
    "DDPrivateNetworkAcl": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-VPCId"}},
        "Tags": [
          {
            "Key": "Name",
            "Value": "DD-private-NACL"
          },
          {
            "Key": "component",
            "Value": "double-digit-test"
          },
          {
            "Key": "environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Scope",
            "Value": "private"
          }
        ]
      }
    },
    "InboundPublicNACLAllPorts": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPrivateNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        },
        "RuleNumber": "101",
        "Protocol": -1,
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "0",
          "To": "65535"
        }
      }
    },
    "OutboundPublicNACLAllPorts": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "DependsOn": ["DDPrivateNetworkAcl"],
      "Properties": {
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": -1,
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "0",
          "To": "65535"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPrivateSubnetA": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-PrivateSubnetId-A"}},
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPrivateSubnetB": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-PrivateSubnetId-B"}},
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPrivateSubnetC": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-PrivateSubnetIdA-DB"}},
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        }
      }
    },
    "DDSubnetNetworkAclAssociationPrivateSubnetD": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${VPCStackName}-PrivateSubnetIdB-DB"}},
        "NetworkAclId": {
          "Ref": "DDPrivateNetworkAcl"
        }
      }
    }
  }
}